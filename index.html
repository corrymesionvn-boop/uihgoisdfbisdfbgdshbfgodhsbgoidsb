#!/bin/bash

# --- C·∫§U H√åNH ---
WEBHOOK_URL="https://discord.com/api/webhooks/1460633815578968239/E5Ck-CCpCwQNUtGXA9z-VpWwcQzZz7M7meSapdb8i7f0cZ_XdnOg4EHeCQ6x4rfmga_2"

# T·ªëi ∆∞u SSH: G·ª≠i t√≠n hi·ªáu gi·ªØ k·∫øt n·ªëi m·ªói 5 gi√¢y
SSH_OPTS="-p 443 -o StrictHostKeyChecking=no -o ServerAliveInterval=5 -o ServerAliveCountMax=3 -o ConnectTimeout=10"

CMD_JAVA="ssh $SSH_OPTS -R0:localhost:25565 tcp@ap.free.pinggy.io"
CMD_BEDROCK="ssh $SSH_OPTS -R0:localhost:25565 udp@ap.free.pinggy.io"

while true
do
    echo "--- [$(date '+%H:%M:%S')] ƒêang d·ªçn d·∫πp v√† kh·ªüi ƒë·ªông Tunnel m·ªõi ---"
    pkill -f "ap.free.pinggy.io"
    sleep 3

    # Ch·∫°y Java & Bedrock d∆∞·ªõi n·ªÅn
    $CMD_JAVA > log_java.txt 2>&1 &
    PID_JAVA=$!
    $CMD_BEDROCK > log_bedrock.txt 2>&1 &
    PID_BEDROCK=$!

    # Ch·ªù l·∫•y IP
    sleep 15
    IP_JAVA=$(grep -oE '(tcp|udp)://[a-zA-Z0-9.-]+\.pinggy\.link:[0-9]+' log_java.txt | sed 's|.*://||' | head -n 1)
    IP_BEDROCK=$(grep -oE '(tcp|udp)://[a-zA-Z0-9.-]+\.pinggy\.link:[0-9]+' log_bedrock.txt | sed 's|.*://||' | head -n 1)

    if [ ! -z "$IP_JAVA" ] || [ ! -z "$IP_BEDROCK" ]; then
        MESSAGE="üîÑ **SERVER RESTARTED / UPDATED** üîÑ\n\n‚òï **JAVA:** \`$IP_JAVA\`\nüì± **BEDROCK:** \`$IP_BEDROCK\`\n\n*(Ch·∫°m v√†o IP ƒë·ªÉ copy)*"
        curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"$MESSAGE\"}" $WEBHOOK_URL
    fi

    # V√íNG L·∫∂P KI·ªÇM TRA "S·ª®C KH·ªéE" TUNNEL (M·ªói 10 gi√¢y)
    for (( i=1; i<=360; i++ ))
    do
        sleep 10
        # 1. Ki·ªÉm tra xem ti·∫øn tr√¨nh SSH c√≥ c√≤n s·ªëng kh√¥ng
        if ! kill -0 $PID_JAVA 2>/dev/null || ! kill -0 $PID_BEDROCK 2>/dev/null; then
            echo "Ph√°t hi·ªán Tunnel s·∫≠p s·ªõm! ƒêang kh·ªüi ƒë·ªông l·∫°i..."
            break
        fi

        # 2. Ch·ªß ƒë·ªông reset sau 55 ph√∫t ƒë·ªÉ tr√°nh Pinggy t·ª± ng·∫Øt ƒë·ªôt ng·ªôt
        if [ $i -eq 330 ]; then
            echo "ƒê√£ ch·∫°y 55 ph√∫t, ch·ªß ƒë·ªông reset ƒë·ªÉ l√†m m·ªõi th·ªùi gian..."
            break
        fi
    done

    # Tr∆∞·ªõc khi k·∫øt th√∫c v√≤ng l·∫∑p ƒë·ªÉ quay l·∫°i ƒë·∫ßu, gi·∫øt s·∫°ch c√°c PID c≈©
    kill $PID_JAVA $PID_BEDROCK 2>/dev/null
    sleep 2
done
